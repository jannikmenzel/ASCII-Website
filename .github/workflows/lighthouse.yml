name: Lighthouse CI

on:
  workflow_dispatch:

jobs:
  lighthouse:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    outputs:
      perf: ${{ steps.scores.outputs.perf }}
      accessibility: ${{ steps.scores.outputs.accessibility }}
      best-practices: ${{ steps.scores.outputs.best-practices }}
      seo: ${{ steps.scores.outputs.seo }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Get deployment URL
        id: url
        run: |
          REPO_NAME="${{ github.repository }}"
          USER_NAME="${REPO_NAME%/*}"
          echo "url=https://${USER_NAME}.github.io/${REPO_NAME#*/}" >> $GITHUB_OUTPUT

      - name: Run Lighthouse CI
        uses: treosh/lighthouse-ci-action@v11
        with:
          urls: |
            ${{ steps.url.outputs.url }}
          uploadArtifacts: false
          temporaryPublicStorage: true
          configPath: ./.github/lighthouse/config.json

      - name: Extract Lighthouse Scores
        id: scores
        run: |
          # Setze Default-Werte
          PERF=0
          ACCESS=0
          BEST=0
          SEO=0
          
          # Prüfe und extrahiere Scores aus verschiedenen möglichen Dateien
          if [ -f ".lighthouseci/assertion-results.json" ]; then
            echo "Found assertion-results.json"
          
            # Methode 1: Versuche aus assertion-results.json zu extrahieren
            if jq -e '.[0].audits.performance.score' .lighthouseci/assertion-results.json > /dev/null 2>&1; then
              PERF=$(jq -r '.[0].audits.performance.score // 0 | . * 100 | round' .lighthouseci/assertion-results.json)
              ACCESS=$(jq -r '.[0].audits.accessibility.score // 0 | . * 100 | round' .lighthouseci/assertion-results.json)
              BEST=$(jq -r '.[0].audits["best-practices"].score // 0 | . * 100 | round' .lighthouseci/assertion-results.json)
              SEO=$(jq -r '.[0].audits.seo.score // 0 | . * 100 | round' .lighthouseci/assertion-results.json)
            fi
          fi
          
          # Alternative: Prüfe auf .lighthouseci/lhr-*.json Dateien
          if [ "$PERF" = "0" ] && ls .lighthouseci/lhr-*.json 1> /dev/null 2>&1; then
            echo "Using lhr-*.json files"
            LHR_FILE=$(ls .lighthouseci/lhr-*.json | head -1)
          
            if [ -f "$LHR_FILE" ]; then
              PERF=$(jq -r '.categories.performance.score // 0 | . * 100 | round' "$LHR_FILE")
              ACCESS=$(jq -r '.categories.accessibility.score // 0 | . * 100 | round' "$LHR_FILE")
              BEST=$(jq -r '.categories["best-practices"].score // 0 | . * 100 | round' "$LHR_FILE")
              SEO=$(jq -r '.categories.seo.score // 0 | . * 100 | round' "$LHR_FILE")
            fi
          fi
          
          echo "Extracted scores:"
          echo "Performance: $PERF"
          echo "Accessibility: $ACCESS"
          echo "Best Practices: $BEST"
          echo "SEO: $SEO"
          
          echo "perf=$PERF" >> $GITHUB_OUTPUT
          echo "accessibility=$ACCESS" >> $GITHUB_OUTPUT
          echo "best-practices=$BEST" >> $GITHUB_OUTPUT
          echo "seo=$SEO" >> $GITHUB_OUTPUT

  update-readme:
    runs-on: ubuntu-latest
    needs: lighthouse
    permissions:
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup git config
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Update README with Lighthouse scores
        run: |
          # Debug: Zeige die extrahierten Scores
          echo "Scores received:"
          echo "Performance: ${{ needs.lighthouse.outputs.perf }}"
          echo "Accessibility: ${{ needs.lighthouse.outputs.accessibility }}"
          echo "Best Practices: ${{ needs.lighthouse.outputs.best-practices }}"
          echo "SEO: ${{ needs.lighthouse.outputs.seo }}"
          
          # Farben basierend auf Scores
          get_color() {
            SCORE=$1
            # Entferne nicht-numerische Zeichen
            SCORE_CLEANED=$(echo "$SCORE" | sed 's/[^0-9]*//g')
          
            if [ -z "$SCORE_CLEANED" ] || [ "$SCORE_CLEANED" = "0" ]; then
              echo "lightgrey"
            elif [ "$SCORE_CLEANED" -ge 90 ]; then
              echo "brightgreen"
            elif [ "$SCORE_CLEANED" -ge 70 ]; then
              echo "green"
            elif [ "$SCORE_CLEANED" -ge 50 ]; then
              echo "yellow"
            else
              echo "red"
            fi
          }
          
          PERF_COLOR=$(get_color "${{ needs.lighthouse.outputs.perf }}")
          ACCESS_COLOR=$(get_color "${{ needs.lighthouse.outputs.accessibility }}")
          BEST_COLOR=$(get_color "${{ needs.lighthouse.outputs.best-practices }}")
          SEO_COLOR=$(get_color "${{ needs.lighthouse.outputs.seo }}")
          
          # README aktualisieren - verschiedene Platzhalter-Varianten unterstützen
          sed -i -E "s|!\[Performance\].*|![Performance](https://img.shields.io/badge/Performance-${{ needs.lighthouse.outputs.perf }}%25-${PERF_COLOR})|g" README.md
          sed -i -E "s|!\[Accessibility\].*|![Accessibility](https://img.shields.io/badge/Accessibility-${{ needs.lighthouse.outputs.accessibility }}%25-${ACCESS_COLOR})|g" README.md
          sed -i -E "s|!\[Best Practices\].*|![Best Practices](https://img.shields.io/badge/Best%20Practices-${{ needs.lighthouse.outputs.best-practices }}%25-${BEST_COLOR})|g" README.md
          sed -i -E "s|!\[SEO\].*|![SEO](https://img.shields.io/badge/SEO-${{ needs.lighthouse.outputs.seo }}%25-${SEO_COLOR})|g" README.md
          
          # Falls Platzhalter vorhanden sind
          sed -i "s/{PERF_SCORE}/${{ needs.lighthouse.outputs.perf }}/g" README.md
          sed -i "s/{ACCESS_SCORE}/${{ needs.lighthouse.outputs.accessibility }}/g" README.md
          sed -i "s/{BEST_SCORE}/${{ needs.lighthouse.outputs.best-practices }}/g" README.md
          sed -i "s/{SEO_SCORE}/${{ needs.lighthouse.outputs.seo }}/g" README.md

      - name: Commit and push changes
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "docs: Update Lighthouse scores in README"
          file_pattern: README.md
          branch: ${{ github.ref }}