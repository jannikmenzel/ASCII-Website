name: Simple Lighthouse Badge

on:
  workflow_run:
    workflows: ["Deploy Hugo site to Pages"]
    types: [completed]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-badge:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup and Build
        run: |
          # Installiere Hugo
          wget -q https://github.com/gohugoio/hugo/releases/download/v0.154.5/hugo_extended_0.154.5_Linux-64bit.tar.gz
          tar -xzf hugo_extended_0.154.5_Linux-64bit.tar.gz
          chmod +x hugo
          
          # Baue Site
          ./hugo --minify

      - name: Quick Lighthouse Test
        id: lh-test
        run: |
          # Installiere Lighthouse
          npm install -g lighthouse
          
          # Starte Server und teste
          ./hugo server --port 8080 --bind 0.0.0.0 &
          sleep 5
          
          # FÃ¼hre Lighthouse aus
          lighthouse http://localhost:8080 \
            --output json \
            --chrome-flags="--headless" \
            --quiet \
            --output-path ./lh-report.json
          
          # Extrahiere Performance Score
          SCORE=$(node -e "console.log(Math.round(require('./lh-report.json').categories.performance.score * 100))")
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Performance Score: $SCORE"

      - name: Update Single Badge in README
        run: |
          SCORE=${{ steps.lh-test.outputs.score }}
          
          # Bestimme Farbe
          if [ $SCORE -ge 90 ]; then
            COLOR="brightgreen"
          elif [ $SCORE -ge 50 ]; then
            COLOR="yellow"
          else
            COLOR="red"
          fi
          
          # Erstelle Badge Markdown
          BADGE="![Lighthouse Score: ${SCORE}/100](https://img.shields.io/badge/Lighthouse-${SCORE}-${COLOR})"
          
          # Aktualisiere README
          if [ ! -f README.md ]; then
            echo "# Project" > README.md
          fi
          
          # Ersetze oder fÃ¼ge Badge hinzu
          if grep -q "!\[Lighthouse Score" README.md; then
            sed -i "s|!\[Lighthouse Score.*|${BADGE}|" README.md
          else
            # FÃ¼ge am Anfang hinzu
            echo -e "${BADGE}\n\n$(cat README.md)" > README.md
          fi
          
          # Committe
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"
          git add README.md
          git commit -m "ðŸ“ˆ Update Lighthouse score: ${SCORE}/100"
          git push