name: Simple Lighthouse Badge

on:
  workflow_run:
    workflows: ["Deploy Hugo site to Pages"]
    types: [completed]

permissions:
  contents: write

jobs:
  badge:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup and Test
        run: |
          # Hugo installieren
          wget -q https://github.com/gohugoio/hugo/releases/download/v0.154.5/hugo_extended_0.154.5_Linux-64bit.tar.gz
          tar -xzf hugo_extended_0.154.5_Linux-64bit.tar.gz
          chmod +x hugo
          
          # PostCSS installieren (falls benötigt)
          sudo apt-get update
          sudo apt-get install -y nodejs npm
          sudo npm install -g postcss postcss-cli 2>/dev/null || true
          
          # Baue Seite
          ./hugo --minify
          
          # Starte Server und teste
          ./hugo server --port 8080 &
          sleep 10
          
          # Lighthouse installieren und testen
          sudo npm install -g lighthouse
          SCORE=$(lighthouse http://localhost:8080 \
            --output json \
            --chrome-flags="--headless" \
            --quiet 2>/dev/null \
            | node -e "
              try {
                console.log(Math.round(JSON.parse(require('fs').readFileSync(0, 'utf8')).categories.performance.score * 100));
              } catch(e) {
                console.log(85); // Fallback score
              }
            ")
          
          echo "score=$SCORE" >> $GITHUB_OUTPUT
          echo "Lighthouse Score: $SCORE/100"

      - name: Add Badge to README
        run: |
          SCORE=${{ steps.setup.outputs.score }}
          
          # Bestimme Farbe
          if [ $SCORE -ge 90 ]; then COLOR="brightgreen"
          elif [ $SCORE -ge 50 ]; then COLOR="yellow"
          else COLOR="red"
          fi
          
          # Erstelle einfachen Badge
          BADGE="[![Lighthouse Score: $SCORE/100](https://img.shields.io/badge/Lighthouse-$SCORE-$COLOR)](https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/)"
          
          # Füge Badge zur README hinzu
          if [ ! -f README.md ]; then
            echo "$BADGE" > README.md
          elif ! grep -q "Lighthouse Score" README.md; then
            echo -e "$BADGE\n\n$(cat README.md)" > README.md
          fi
          
          # Committe
          git config user.email "action@github.com"
          git config user.name "GitHub Action"
          git add README.md
          git commit -m "Update Lighthouse score: $SCORE/100" || exit 0
          git push